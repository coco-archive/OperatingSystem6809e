  MAIN
*******
*SHELL*
*******
**PUBLIC VARS**(FOR EXTRN CODE)

**FILE STRUCT**
IODEV  EQU 0
IORW   EQU 1
IOADD  EQU 2
IOLEN  EQU 4
IONAME EQU 6
IODR   EQU 17
IOL    EQU IODR+1

**MESSAGE BLOCK STRUCT**
TNXT   EQU 0   NEXT MESSAGE
TPIN   EQU 2   PIN OF SENDER
TLEN   EQU 4   MESS LENGTH
TDATA  EQU 6   MESSAGE DATA
TMLEN  EQU TLEN+2   MESS HEADER LENGTH

*MSG CONSTRUCTS FOR RECEIVER
TSEND  EQU 0   SENDER'S PIN
TL     EQU 2   LENGTH
TMSG   EQU 4   MSG LOC AFTER REC'ED

**SEMAPHORE**
SVAL   EQU 0   VALUE OF SEMP
SBLOC  EQU 2   LINK OF BLOCKED PCBS
SCNT   EQU 4   # PCBS BLOCKED
SOWN   EQU 6   LINK FROM PCB OWNING SEMP
SLEN   EQU SOWN+2    SEMP LENGTH

**MEM BLOCK**
MLEN   EQU 0   LENGTH OF THIS MEM BLOCK
MF     EQU 2   LINK TO NEXT
MB     EQU 4   LINK TO LAST
MTYPE  EQU 6   TYPE OF MEMORY
MPIN   EQU 8   PIN OF CREATOR
MDATA  EQU 10  DATA
ML     EQU MDATA   LENGTH OF MEM BLOCK

**PCB BLOCK**
PNAM   EQU 0    NAME OF PCB
PPIN   EQU 8    PIN OF PCB
PNXT   EQU 10   ACTIVE PCB CHAIN
PSTK   EQU 12   STACK POINTER
PHED   EQU 14   WHAT LINK PCB ON
PSEM   EQU 16   OWNED SEMP LIST
PCNT   EQU 18   COUNT OF INTERUPTS
PST    EQU 20   STATUS
PCHN   EQU 22   LINK OF ALL PCBS
PMSG   EQU 24   MESSAGES LINK
PREC   EQU 26   JUST RECIEVED MSG
PXE    EQU 28   MESSAGE EMPTY SEMP
PXF    EQU 36   MESSAGE FULL SEMP
PRD    EQU 44   IOREAD SPECIFIC TO PCB
PWT    EQU 46   WRT SPEC.
PJOB   EQU 48   JOB PROGRAM AREA
PEND   EQU 50   LOWER STACK LIMIT
PAREA  EQU 128  128 BYTES PER PCB
PL     EQU 128

**SWI OS SERVICE CALL ROUTINE NAMES**
**USE LDA #NAME**
CREATE EQU 0   CREATE PROCESS
DEST   EQU 1   DESTROY PROCESS
GET    EQU 2   GET MEMORY
FREE   EQU 3   FREE MEMORY
ALSEM  EQU 4   ALOCATE SEMP
FRSEM  EQU 5   FREE SEMP
P      EQU 6   MUTEX P OPERATOR
V      EQU 7   MUTEX V OPERATOR
SEND   EQU 8   SEND A MESSAGE
REC    EQU 9   RECEIVE A MESSAGE
WRITE  EQU 10  WRITE TO SCREEN
READ   EQU 11  READ FROM KEYS
DISK   EQU 12  ACCESS DISK
IO     EQU 13  CALL I/O WITH IO REQ BLOCK
OPENRD EQU 14  OPEN FOR READING
OPENWT EQU 15  OPEN FOR WRITING
READD  EQU 16  READ FROM DISK
CLOSE  EQU 17  CLOSE FILE
GOR    EQU 18  GENERAL OPEN READ
GOW    EQU 19  GENERAL OPEN WRITE
EXEC   EQU 20  EXECUTE A FILE
PULL   EQU 21  1ST SPACE
PUSH   EQU 22  1ST 'SPACE

COC    EQU 128
KEY    EQU 127

SHELL  LDA  #READ
       LDB  #1
       LDX  #113
       SWI

       LDA  #GET
       LDX  #130
       LDB  #65
       SWI
       TFR  X,U
SHST   CLR  COC,U
       INC  COC,U
       CLRB
       LDA  #32
CLRSH  STA  B,U
       INCB
       CMPB #126
       BNE  CLRSH
       LDA  #255
       STA  120,U
       LDB  #8
       LDA  #WRITE
       TFR  PC,X
       LEAX 5,X
       SWI
       BRA SHLP
       FCB  13
       FCC  /BTOS>/
       FCB  255
       FCB  8

SHLP   LDB  COC,U
       CMPB #100
       LBEQ GOEXEC
       LDA  #READ
       LEAX KEY,U
       LDB  #1
       SWI
       LDA  KEY,U
       CMPA #8
       BNE  GOSHOW
       LDB  COC,U
       CMPB #1
       BEQ  NOSHOW
GOSHOW LDB  COC,U
       LEAX B,U
       STA  ,X
       LEAX KEY,U
       LDB  #1
       LDA  #WRITE
       SWI
NOSHOW LDA  KEY,U
       LDB  COC,U
       CMPA #8    BACKSPCE
       BNE  NOBACK
       CMPB #1
       BEQ  NOBACK
       DEC  COC,U
       BRA  NOFWD
NOBACK INC  COC,U

NOFWD  LDB  #4
       LDA  #WRITE
       TFR  PC,X
       LEAX 6,X
       SWI
       LBRA HUGA

       FCB  255
       FCB  32
       FCB  8
       FCB  8

HUGA   LDA  KEY,U
       CMPA #13
       BNE  SHLP

GOEXEC LDA  #32
       LDB  COC,U
       DECB
       STA  B,U
       TFR  U,X
       LEAX 1,X
       LDA  #EXEC
       SWI
       TSTA
       LBEQ SHST
       LDB  #8
       LDA  #WRITE
      
