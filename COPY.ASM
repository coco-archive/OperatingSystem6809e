  MAIN
******
*COPY*
******
**PUBLIC VARS**(FOR EXTRN CODE)

**FILE STRUCT**
IODEV  EQU 0
IORW   EQU 1
IOADD  EQU 2
IOLEN  EQU 4
IONAME EQU 6
IODR   EQU 17

WODEV  EQU 18
WORW   EQU 19
WOADD  EQU 20
WOLEN  EQU 22
WONAME EQU 24
WODR   EQU 35


ASAVE  EQU 36
XSAVE  EQU 37
IOL    EQU XSAVE+2

**MESSAGE BLOCK STRUCT**
TNXT   EQU 0   NEXT MESSAGE
TPIN   EQU 2   PIN OF SENDER
TLEN   EQU 4   MESS LENGTH
TDATA  EQU 6   MESSAGE DATA
TMLEN  EQU TLEN+2   MESS HEADER LENGTH

*MSG CONSTRUCTS FOR RECEIVER
TSEND  EQU 0   SENDER'S PIN
TL     EQU 2   LENGTH
TMSG   EQU 4   MSG LOC AFTER REC'ED

**SEMAPHORE**
SVAL   EQU 0   VALUE OF SEMP
SBLOC  EQU 2   LINK OF BLOCKED PCBS
SCNT   EQU 4   # PCBS BLOCKED
SOWN   EQU 6   LINK FROM PCB OWNING SEMP
SLEN   EQU SOWN+2    SEMP LENGTH

**MEM BLOCK**
MLEN   EQU 0   LENGTH OF THIS MEM BLOCK
MF     EQU 2   LINK TO NEXT
MB     EQU 4   LINK TO LAST
MTYPE  EQU 6   TYPE OF MEMORY
MPIN   EQU 8   PIN OF CREATOR
MDATA  EQU 10  DATA
ML     EQU MDATA   LENGTH OF MEM BLOCK

**PCB BLOCK**
PNAM   EQU 0    NAME OF PCB
PPIN   EQU 8    PIN OF PCB
PNXT   EQU 10   ACTIVE PCB CHAIN
PSTK   EQU 12   STACK POINTER
PHED   EQU 14   WHAT LINK PCB ON
PSEM   EQU 16   OWNED SEMP LIST
PCNT   EQU 18   COUNT OF INTERUPTS
PST    EQU 20   STATUS
PCHN   EQU 22   LINK OF ALL PCBS
PMSG   EQU 24   MESSAGES LINK
PREC   EQU 26   JUST RECIEVED MSG
PXE    EQU 28   MESSAGE EMPTY SEMP
PXF    EQU 36   MESSAGE FULL SEMP
PRD    EQU 44   IOREAD SPECIFIC TO PCB
PWT    EQU 46   WRT SPEC.
PJOB   EQU 48   JOB PROGRAM AREA
PEND   EQU 50   LOWER STACK LIMIT
PAREA  EQU 128  128 BYTES PER PCB
PL     EQU 128

**SWI OS SERVICE CALL ROUTINE NAMES**
**USE LDA #NAME**
CREATE EQU 0   CREATE PROCESS
DEST   EQU 1   DESTROY PROCESS
GET    EQU 2   GET MEMORY
FREE   EQU 3   FREE MEMORY
ALSEM  EQU 4   ALOCATE SEMP
FRSEM  EQU 5   FREE SEMP
P      EQU 6   MUTEX P OPERATOR
V      EQU 7   MUTEX V OPERATOR
SEND   EQU 8   SEND A MESSAGE
REC    EQU 9   RECEIVE A MESSAGE
WRITE  EQU 10  WRITE TO SCREEN
READ   EQU 11  READ FROM KEYS
DISK   EQU 12  ACCESS DISK
IO     EQU 13  CALL I/O WITH IO REQ BLOCK
OPENRD EQU 14  OPEN FOR READING
OPENWT EQU 15  OPEN FOR WRITING
READD  EQU 16  READ FROM DISK
CLOSE  EQU 17  CLOSE FILE
GOR    EQU 18  GENERAL OPEN READ
GOW    EQU 19  GENERAL OPEN WRITE
EXEC   EQU 20  EXECUTE A FILE
PULL   EQU 21  1ST SPACE
PUSH   EQU 22  1ST 'SPACE
EXPAND EQU 23

TYPE   LDA  #REC
       SWI
       LEAX TMSG,X
       TFR  PC,Y
       LEAY 5,Y
       LBRA ARND
       RMB  IOL+92

ARND   STX  XSAVE,Y
       LDA  #1
       STA  WORW,Y
       CLR  IORW,Y
       LDA  #2
       STA  IODEV,Y
       STA  WODEV,Y
       TFR  Y,D
       ADDD #IOL
       STD  IOADD,Y
       STD  WOADD,Y
       LDD  #32
       STD  IOLEN,Y
       STD  WOLEN,Y
       CLR  IODR,Y
       CLR  WODR,Y
       LDA  #PULL
       SWI
       LDA  #PUSH
       SWI
       LDA  #EXPAND
       SWI
       LEAY WONAME,Y
       CLR  11,X
       CLRB
LPCP2  LDA  B,X
       STA  B,Y
       INCB
       CMPB #12
       BNE  LPCP2
       LDB  #2
       LDA  #OPENWT
       SWI
       TSTA
       LBNE TPEND
       LEAY -WONAME,Y

       CLR  1300
       LDX  XSAVE,Y
       LDA  #EXPAND
       SWI
       CLR  1301
       LEAY IONAME,Y
       CLR  11,X
       CLRB
LPCP   LDA  B,X
       STA  B,Y
       INCB
       CMPB #12
       BNE  LPCP
       LDB  #2
       LDA  #OPENRD
       SWI
       CLR  1302
       TSTA
       BNE  TPEND
       CLR  1303
       LEAY -IONAME,Y
RDAGN  TFR  Y,U
       LDA  #IO
       SWI
       CLR  1304
       STA  ASAVE,U
       TFR  Y,D
       STD  WOLEN,U
       TFR  U,Y
       LEAY WODEV,U
       LDA  #IO
       SWI
       CLR  1305
       TFR  U,Y
       TST  ASAVE,Y
       LBEQ RDAGN
LASTRD LEAY IONAME,Y
       LDB  #2
       LDA  #CLOSE
       SWI
       LEAY -IONAME,Y
       LEAY WONAME,Y
       LDB  #2
       LDA  #CLOSE
       SWI
      
